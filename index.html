<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <!-- 
    2026 é¦¬å¹´ç‰¹ä»•ç‰ˆ - iOS 26 è¦–è¦ºå‡ç´šå°ˆæ¡ˆ
    æ¶æ§‹ï¼šHTML5 + React 18 + TailwindCSS + åŸç”Ÿ Canvas API ç²’å­å¼•æ“
  -->
  <title>2026 é‡‘é¦¬è¿æ˜¥ï¼å¤§è€äºŒè¨˜åˆ†æ‰€</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    /* ==========================================
       iOS 26 è¨­è¨ˆç³»çµ± & è®Šæ•¸å®£å‘Š
       å¼·èª¿é«˜å‹•æ…‹ç¯„åœçš„è‰²å½©èˆ‡æ¥µè‡´çš„ç•™ç™½
    ========================================== */
    :root {
      --safe-top: env(safe-area-inset-top, 44px);
      --safe-bottom: env(safe-area-inset-bottom, 34px);
      
      /* è‰²å½©ç³»çµ±ï¼šæ·±é‚ƒçš„å‹ƒè‰®ç¬¬ç´…èˆ‡é–ƒè€€é‡‘ */
      --color-bg-deep: #1a0000;
      --color-bg-mid: #3f0000;
      --color-gold-light: #fef08a;
      --color-gold-base: #fbbf24;
      --color-gold-dark: #b45309;
      --color-glass-border: rgba(255, 255, 255, 0.12);
      --color-glass-bg: rgba(30, 0, 0, 0.55);
    }

    /* åŸºç¤é‡ç½®èˆ‡é˜²å‘†ï¼Œæ­»å®ˆã€Œä¸æ²å‹•ã€åŸå‰‡ */
    body {
      margin: 0;
      padding: 0;
      background-color: var(--color-bg-deep);
      color: #ffffff;
      overflow: hidden; 
      /* å­—é«”å®¶æ—ï¼šè˜‹æœç”Ÿæ…‹ç³»å„ªå…ˆï¼Œå‘ˆç¾æœªä¾†è³ªæ„Ÿ */
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "PingFang TC", "Helvetica Neue", sans-serif;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      touch-action: none; /* å¾¹åº•å°æ®ºç€è¦½å™¨é è¨­æ‰‹å‹¢ï¼ˆå¦‚ä¸‹æ‹‰æ›´æ–°ï¼‰ */
    }

    #root {
      width: 100vw;
      height: 100dvh;
      position: relative;
    }

    /* ==========================================
       Canvas ç•«å¸ƒå°ˆå±¬åœ–å±¤
       æ”¾åœ¨æœ€åº•å±¤ï¼Œä¸å¹²æ“¾ä»»ä½• DOM æ“ä½œ
    ========================================== */
    #fx-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      pointer-events: none; /* äº‹ä»¶ç©¿é€ï¼Œè®“ä¸‹æ–¹æŒ‰éˆ•å¯è¢«é»æ“Š */
    }

    /* ==========================================
       Glassmorphism æ¯›ç»ç’ƒè³ªæ„Ÿ (iOS 26 æ ¸å¿ƒèªå½™)
       åˆ©ç”¨å¤šé‡é™°å½±èˆ‡èƒŒæ™¯æ¨¡ç³Šæ‰“é€ æ·±åº¦
    ========================================== */
    .ios-glass-card {
      background: var(--color-glass-bg);
      backdrop-filter: blur(28px) saturate(200%);
      -webkit-backdrop-filter: blur(28px) saturate(200%);
      border: 1px solid var(--color-glass-border);
      /* å…§å¤–é™°å½±ç–ŠåŠ ï¼Œè£½é€ æ‡¸æµ®æ„Ÿ */
      box-shadow: 
        0 24px 48px rgba(0, 0, 0, 0.4), 
        inset 0 1px 1px rgba(255, 255, 255, 0.15);
      border-radius: 28px;
    }

    .ios-glass-nav {
      background: rgba(20, 0, 0, 0.75);
      backdrop-filter: blur(40px) saturate(250%);
      -webkit-backdrop-filter: blur(40px) saturate(250%);
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 -10px 30px rgba(0,0,0,0.5);
    }

    /* æ–‡å­—æµå…‰ç‰¹æ•ˆï¼šä¸­åœ‹é¢¨æ¨™é¡Œä½¿ç”¨ */
    @keyframes text-shine {
      0% { background-position: 0% 50%; }
      100% { background-position: 200% 50%; }
    }
    
    .text-shine-gold {
      background: linear-gradient(
        110deg, 
        var(--color-gold-dark) 0%, 
        var(--color-gold-base) 20%, 
        #ffffff 40%, 
        var(--color-gold-base) 60%, 
        var(--color-gold-dark) 100%
      );
      background-size: 200% auto;
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      animation: text-shine 5s linear infinite;
    }

    /* å·¥å…·é¡åˆ¥ */
    .tabular-nums { font-variant-numeric: tabular-nums; }
    
    /* éš±è—åŸç”Ÿæ²è»¸ä½†ä¿ç•™æ²å‹•åŠŸèƒ½ (æ­·å²ç´€éŒ„å€ä½¿ç”¨) */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { scrollbar-width: none; overflow-y: auto; overflow-x: hidden; overscroll-behavior: contain; }

    /* æŒ‰éˆ•é»æ“Šçš„å›é¥‹å‹•ç•« */
    .ios-active-scale:active {
      transform: scale(0.96);
      transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1);
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useMemo, useCallback } = React;

    /* =====================================================================
       [æ ¸å¿ƒå¼•æ“] Canvas API é«˜æ€§èƒ½ç²’å­ç³»çµ±
       é€™è£¡è™•ç†æ‰€æœ‰è¦–è¦ºç‰¹æ•ˆï¼Œé‡‹æ”¾ DOM ç¯€é»çš„å£“åŠ›ã€‚
       åŒ…å«ï¼šç´…åŒ…é›¨ã€èƒŒæ™¯æ˜Ÿå¡µå‘¼å¸ã€å‹åˆ©é‡‘å¹£å™´ç™¼ã€‚
    ===================================================================== */
    
    // åŸºç¤æ•¸å­¸èˆ‡å‘é‡å·¥å…· (é¿å…ä¾è³´å¤–éƒ¨åº«)
    class Vector2 {
      constructor(x = 0, y = 0) { this.x = x; this.y = y; }
      add(v) { this.x += v.x; this.y += v.y; return this; }
      sub(v) { this.x -= v.x; this.y -= v.y; return this; }
      mult(n) { this.x *= n; this.y *= n; return this; }
      mag() { return Math.sqrt(this.x * this.x + this.y * this.y); }
      normalize() { const m = this.mag(); if (m !== 0) this.mult(1 / m); return this; }
      copy() { return new Vector2(this.x, this.y); }
    }

    const randomRange = (min, max) => Math.random() * (max - min) + min;

    // --- ç²’å­åŸºåº•é¡åˆ¥ ---
    class Particle {
      constructor(x, y) {
        this.pos = new Vector2(x, y);
        this.vel = new Vector2(0, 0);
        this.acc = new Vector2(0, 0);
        this.life = 1.0; 
        this.decay = randomRange(0.005, 0.015);
      }
      applyForce(force) { this.acc.add(force); }
      update() {
        this.vel.add(this.acc);
        this.pos.add(this.vel);
        this.acc.mult(0); // æ¯å¹€é‡ç½®åŠ é€Ÿåº¦
        this.life -= this.decay;
      }
      isDead() { return this.life <= 0; }
    }

    // --- ç‰¹æ•ˆ Aï¼šé¦¬å¹´ç´…åŒ…é›¨ ---
    class RedEnvelope extends Particle {
      constructor(canvasWidth, canvasHeight) {
        // å¾é ‚éƒ¨éš¨æ©Ÿä½ç½®å‡ºç”Ÿ
        super(randomRange(0, canvasWidth), randomRange(-100, -20));
        this.canvasHeight = canvasHeight;
        this.width = randomRange(16, 28);
        this.height = this.width * 1.4;
        this.vel = new Vector2(randomRange(-0.5, 0.5), randomRange(2, 4));
        this.mass = this.width * 0.05;
        this.angle = randomRange(0, Math.PI * 2);
        this.spin = randomRange(-0.05, 0.05);
        this.wobblePhase = randomRange(0, Math.PI * 2);
        this.wobbleSpeed = randomRange(0.02, 0.05);
        // ç´…åŒ…çš„ç”Ÿå‘½é€±æœŸç”±æ‰å‡ºç•«é¢æ±ºå®šï¼Œä¸éš¨æ™‚é–“è¡°æ¸›
        this.decay = 0; 
      }

      update() {
        super.update();
        this.angle += this.spin;
        this.wobblePhase += this.wobbleSpeed;
        // åŠ å…¥ç©ºæ°£é˜»åŠ›é€ æˆçš„å·¦å³æ–æ“º (Swaying)
        this.pos.x += Math.sin(this.wobblePhase) * 1.5;
        
        // å¦‚æœæ‰å‡ºç•«é¢åº•éƒ¨ï¼Œæ¨™è¨˜æ­»äº¡
        if (this.pos.y > this.canvasHeight + 100) {
          this.life = 0;
        }
      }

      draw(ctx) {
        ctx.save();
        ctx.translate(this.pos.x, this.pos.y);
        ctx.rotate(this.angle);
        
        // ç•«ç´…åŒ…ä¸»é«” (å¸¶é»å¾®å…‰)
        ctx.fillStyle = '#dc2626'; // Tailwind red-600
        ctx.shadowColor = 'rgba(220, 38, 38, 0.5)';
        ctx.shadowBlur = 10;
        ctx.beginPath();
        ctx.roundRect(-this.width/2, -this.height/2, this.width, this.height, 3);
        ctx.fill();

        // ç•«ç´…åŒ…ä¸Šè“‹æŠ˜è§’
        ctx.shadowBlur = 0;
        ctx.fillStyle = '#b91c1c'; // Tailwind red-700
        ctx.beginPath();
        ctx.moveTo(-this.width/2, -this.height/2);
        ctx.lineTo(0, -this.height/4);
        ctx.lineTo(this.width/2, -this.height/2);
        ctx.fill();

        // ç•«ä¸­å¤®é»ƒé‡‘è£é£¾éˆ•æ‰£
        ctx.fillStyle = '#fbbf24'; // Tailwind amber-400
        ctx.beginPath();
        ctx.arc(0, -this.height/8, this.width/6, 0, Math.PI * 2);
        ctx.fill();

        ctx.restore();
      }
    }

    // --- ç‰¹æ•ˆ Bï¼šèƒŒæ™¯å‘¼å¸æ˜Ÿå¡µ ---
    class GoldDust extends Particle {
      constructor(canvasWidth, canvasHeight) {
        super(randomRange(0, canvasWidth), randomRange(0, canvasHeight));
        this.radius = randomRange(0.5, 2.5);
        // ç·©æ…¢å‘ä¸Šæ¼‚æµ®
        this.vel = new Vector2(randomRange(-0.2, 0.2), randomRange(-0.1, -0.5));
        this.decay = randomRange(0.001, 0.003); // å£½å‘½å¾ˆé•·
        this.maxLife = 1.0;
        // åˆå§‹é€æ˜åº¦éš¨æ©Ÿï¼Œå‘ˆç¾å‘¼å¸æ„Ÿ
        this.pulsePhase = randomRange(0, Math.PI * 2);
      }

      update() {
        super.update();
        this.pulsePhase += 0.02;
      }

      draw(ctx) {
        ctx.save();
        // å‘¼å¸ç‡ˆé€æ˜åº¦è¨ˆç®—
        const alpha = Math.max(0, Math.sin(this.pulsePhase) * 0.5 + 0.5) * this.life;
        ctx.globalAlpha = alpha;
        ctx.fillStyle = '#fde68a'; // Tailwind amber-200
        ctx.shadowColor = '#fbbf24';
        ctx.shadowBlur = 8;
        ctx.beginPath();
        ctx.arc(this.pos.x, this.pos.y, this.radius, 0, Math.PI * 2);
        ctx.fill();
        ctx.restore();
      }
    }

    // --- Canvas ç®¡ç†èˆ‡æ¸²æŸ“å¼•æ“ ---
    const CanvasManager = () => {
      const canvasRef = useRef(null);
      
      useEffect(() => {
        const canvas = canvasRef.current;
        if (!canvas) return;
        const ctx = canvas.getContext('2d', { alpha: false }); // é—œé–‰ alpha é€šé“ä»¥æ¦¨å–æ¥µè‡´æ•ˆèƒ½
        
        let width = window.innerWidth;
        let height = window.innerHeight;
        let animationFrameId;

        // è™•ç† Retina è¢å¹•é«˜è§£æåº¦ (DPI)
        const setupCanvas = () => {
          width = window.innerWidth;
          height = window.innerHeight;
          const dpr = window.devicePixelRatio || 1;
          canvas.width = width * dpr;
          canvas.height = height * dpr;
          ctx.scale(dpr, dpr);
        };
        setupCanvas();
        window.addEventListener('resize', setupCanvas);

        // ç²’å­é™£åˆ—
        const envelopes = [];
        const dusts = [];
        
        // ç’°å¢ƒåŠ›
        const gravity = new Vector2(0, 0.05);

        // ä¸»æ¸²æŸ“è¿´åœˆ
        const render = () => {
          // ç¹ªè£½æ·±é‚ƒèƒŒæ™¯æ¼¸å±¤ (å–ä»£åŸæœ¬çš„ CSS background)
          const bgGradient = ctx.createRadialGradient(width * 0.5, height * 0.3, 0, width * 0.5, height * 0.5, height * 0.8);
          bgGradient.addColorStop(0, '#3f0000'); // äº®éƒ¨ä¸­å¿ƒ
          bgGradient.addColorStop(1, '#0a0000'); // æš—éƒ¨é‚Šç·£
          ctx.fillStyle = bgGradient;
          ctx.fillRect(0, 0, width, height);

          // è£œå……æ˜Ÿå¡µ
          if (dusts.length < 80) {
            dusts.push(new GoldDust(width, height));
          }
          
          // è£œå……ç´…åŒ… (æ§åˆ¶é »ç‡ï¼Œé¿å…ç•«é¢éåº¦é›œäº‚ï¼Œç¬¦åˆ iOS ç°¡æ½”ç¾å­¸)
          if (Math.random() < 0.02 && envelopes.length < 15) {
            envelopes.push(new RedEnvelope(width, height));
          }

          // ç¹ªè£½èˆ‡æ›´æ–°æ˜Ÿå¡µ
          for (let i = dusts.length - 1; i >= 0; i--) {
            const d = dusts[i];
            d.update();
            d.draw(ctx);
            if (d.isDead()) dusts.splice(i, 1);
          }

          // ç¹ªè£½ä¸€åŒ¹æ¥µç°¡çš„é¦¬å¹´æµ®æ°´å° (ä½¿ç”¨ Path2D ç¹ªè£½å¹¾ä½•ç·šæ¢)
          ctx.save();
          ctx.translate(width * 0.5, height * 0.4);
          ctx.scale(1.5, 1.5);
          ctx.globalAlpha = 0.05; // æ¥µåº¦æ·¡åŒ–ï¼Œç‡Ÿé€ å‘¼å¸æ„Ÿç•™ç™½
          ctx.strokeStyle = '#fbbf24';
          ctx.lineWidth = 2;
          ctx.beginPath();
          // ç°¡åŒ–çš„æ‘ºç´™é¢¨æ ¼é¦¬åŒ¹è¼ªå»“
          ctx.moveTo(10, -30);
          ctx.lineTo(20, -10);
          ctx.lineTo(-10, 10);
          ctx.lineTo(-30, 40);
          ctx.lineTo(-10, 50);
          ctx.lineTo(20, 20);
          ctx.lineTo(40, 50);
          ctx.lineTo(60, 40);
          ctx.lineTo(30, -10);
          ctx.closePath();
          ctx.stroke();
          ctx.restore();

          // ç¹ªè£½èˆ‡æ›´æ–°ç´…åŒ…é›¨
          for (let i = envelopes.length - 1; i >= 0; i--) {
            const e = envelopes[i];
            // é‡åŠ›æœƒæ ¹æ“šç´…åŒ…è³ªé‡ç”¢ç”Ÿä¸åŒåŠ é€Ÿåº¦
            const weight = new Vector2(0, gravity.y * e.mass);
            e.applyForce(weight);
            e.update();
            e.draw(ctx);
            if (e.isDead()) envelopes.splice(i, 1);
          }

          animationFrameId = requestAnimationFrame(render);
        };

        render();

        return () => {
          window.removeEventListener('resize', setupCanvas);
          cancelAnimationFrame(animationFrameId);
        };
      }, []);

      return <canvas id="fx-canvas" ref={canvasRef} />;
    };

    /* =====================================================================
       UI å…ƒä»¶åº«ï¼šSvg Icons
       ä½¿ç”¨æ›´ç´°ç·»ã€åœ“æ½¤çš„ç·šæ¢ï¼Œå‘¼æ‡‰ iOS çš„ Human Interface Guidelinesã€‚
    ===================================================================== */
    const Icon = ({ name, className = "w-6 h-6", strokeWidth = "1.5" }) => {
      const svgs = {
        trophy: <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>,
        history: <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></svg>,
        play: <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="4"/><path d="M10 8l6 4-6 4V8z"/></svg>,
        minus: <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"/></svg>,
        plus: <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
        info: <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>,
        crown: <svg className={className} viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M2.2 19.5h19.6v2H2.2v-2zm1.4-2.8l2.8-10.2L12 13.8l5.6-7.3 2.8 10.2H3.6z"/></svg>,
        close: <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      };
      return svgs[name] || null;
    };

    /* =====================================================================
       é ˜åŸŸå…ƒä»¶ï¼šè¨˜åˆ†å¡ç‰‡ (Play Tab)
       å¤§å¹…å¢åŠ å¡ç‰‡å…§çš„ç•™ç™½ã€æ–‡å­—è§£èªªèˆ‡åœ“è§’ï¼Œè®“æ“ä½œæ›´ç›´è¦ºã€‚
    ===================================================================== */
    const PlayerControlCard = ({ 
      player, 
      currentCards, 
      twoCount, 
      onChangeCard, 
      onToggleTwo 
    }) => {
      const isWinner = currentCards === 0;
      
      // å‹•æ…‹åˆ¤å®šå¡ç‰‡ç‹€æ…‹ï¼Œçµ¦äºˆä¸åŒçš„è¦–è¦ºå›é¥‹
      const cardStateClass = isWinner 
        ? 'opacity-60 grayscale-[30%]' // è„«æ‰‹è€…å‘ˆç¾åŠéš±è—ç‹€æ…‹
        : twoCount > 0 
          ? 'ring-2 ring-amber-500/50 bg-amber-900/20' // æ¡æœ‰è€äºŒçš„é«˜é¢¨éšªè­¦å‘Š
          : '';

      return (
        <div className={`ios-glass-card p-5 transition-all duration-300 ${cardStateClass}`}>
          <div className="flex items-center justify-between mb-4">
            {/* å·¦å´ï¼šèº«åˆ†èˆ‡ç‹€æ…‹æ¨™ç±¤ */}
            <div className="flex flex-col gap-1.5">
              <span className="text-[22px] font-bold tracking-wide text-white">{player.name}</span>
              <button 
                onClick={onToggleTwo}
                disabled={isWinner}
                className={`
                  w-fit px-3 py-1.5 rounded-full text-[12px] font-semibold flex items-center gap-1 transition-all ios-active-scale
                  ${isWinner 
                    ? 'bg-white/10 text-white/40' 
                    : twoCount > 0 
                      ? 'bg-amber-500/20 text-amber-300 border border-amber-500/50 shadow-[0_0_15px_rgba(245,158,11,0.2)]' 
                      : 'bg-white/5 text-white/60 border border-white/10'
                  }
                `}
              >
                {isWinner ? 'ğŸ‰ æ¼‚äº®è„«æ‰‹' : twoCount > 0 ? `ğŸ’£ æ‰£ç•™è€äºŒ Ã— ${twoCount}` : 'å¹³éœç„¡æ³¢ (ç„¡è€äºŒ)'}
              </button>
            </div>
            
            {/* å³å´ï¼šæ­¥é€²å™¨ (Stepper) æ§åˆ¶ç‰Œæ•¸ */}
            <div className="flex flex-col items-end gap-1">
              <span className="text-[11px] text-white/40 font-medium tracking-wider">ç›®å‰æ‰‹ç‰Œæ•¸</span>
              <div className="flex items-center gap-2 bg-black/40 p-1.5 rounded-[20px] border border-white/5 shadow-inner">
                <button 
                  onClick={() => onChangeCard(-1)} 
                  className="w-11 h-11 rounded-[14px] bg-white/10 flex items-center justify-center text-white/80 ios-active-scale hover:bg-white/20 transition-colors"
                >
                  <Icon name="minus" className="w-5 h-5" />
                </button>
                <div className="w-12 text-center text-[28px] font-bold tabular-nums text-white">
                  {currentCards}
                </div>
                <button 
                  onClick={() => onChangeCard(1)} 
                  className="w-11 h-11 rounded-[14px] bg-white/10 flex items-center justify-center text-white/80 ios-active-scale hover:bg-white/20 transition-colors"
                >
                  <Icon name="plus" className="w-5 h-5" />
                </button>
              </div>
            </div>
          </div>
          
          {/* é€²åº¦æ¢æŒ‡ç¤ºå™¨ (æ»¿ç‰Œ13å¼µ) */}
          <div className="w-full h-1.5 bg-black/50 rounded-full overflow-hidden">
            <div 
              className={`h-full rounded-full transition-all duration-300 ${isWinner ? 'bg-emerald-400' : currentCards >= 8 ? 'bg-red-500' : 'bg-amber-400'}`}
              style={{ width: `${(currentCards / 13) * 100}%` }}
            />
          </div>
        </div>
      );
    };

    /* =====================================================================
       ä¸»æ‡‰ç”¨ç¨‹å¼é‚è¼¯ (State & Controllers)
       é€™è£¡çš„çµç®—é‚è¼¯å®Œå…¨éµå¾ªä½ çš„æ—¢æœ‰è¦å‰‡ï¼Œä¸ä½œä»»ä½•æ›´å‹•ã€‚
    ===================================================================== */
    const App = () => {
      const INITIAL_PLAYERS = useMemo(() => [
        { id: 'p1', name: 'çˆ¸çˆ¸', score: 0 },
        { id: 'p2', name: 'åª½åª½', score: 0 },
        { id: 'p3', name: 'å“¥å“¥', score: 0 },
        { id: 'p4', name: 'å¦¹å¦¹', score: 0 },
      ], []);

      // ç‹€æ…‹ç®¡ç†
      const [players, setPlayers] = useState(INITIAL_PLAYERS);
      const [history, setHistory] = useState([]);
      const [activeTab, setActiveTab] = useState('play');
      const [currentCards, setCurrentCards] = useState({ p1: 0, p2: 0, p3: 0, p4: 0 });
      const [twoCounts, setTwoCounts] = useState({ p1: 0, p2: 0, p3: 0, p4: 0 });
      const [winnerTwoCount, setWinnerTwoCount] = useState(0);
      const [showRules, setShowRules] = useState(false);

      // åˆå§‹åŒ–è³‡æ–™è®€å–
      useEffect(() => {
        const savedP = localStorage.getItem('big2_players_ios26_pro');
        const savedH = localStorage.getItem('big2_history_ios26_pro');
        if (savedP) setPlayers(JSON.parse(savedP));
        if (savedH) setHistory(JSON.parse(savedH));
      }, []);

      // è³‡æ–™è®Šæ›´æ™‚è‡ªå‹•å„²å­˜
      useEffect(() => {
        localStorage.setItem('big2_players_ios26_pro', JSON.stringify(players));
        localStorage.setItem('big2_history_ios26_pro', JSON.stringify(history));
      }, [players, history]);

      // æ“ä½œï¼šèª¿æ•´ç‰Œæ•¸
      const changeCard = useCallback((id, delta) => {
        setCurrentCards(prev => {
          const newVal = Math.max(0, Math.min(13, prev[id] + delta));
          if (newVal === 0) setTwoCounts(p => ({ ...p, [id]: 0 }));
          return { ...prev, [id]: newVal };
        });
      }, []);

      // æ“ä½œï¼šåˆ‡æ›æŒæœ‰çš„è€äºŒæ•¸é‡ (0~4)
      const toggleTwo = useCallback((id) => {
        if (currentCards[id] === 0) return;
        setTwoCounts(prev => ({ ...prev, [id]: (prev[id] + 1) % 5 }));
      }, [currentCards]);

      // æ ¸å¿ƒé‚è¼¯ï¼šçµç®—é‡‘é¡ (ä¿ç•™åŸæ±åŸå‘³)
      const calculate = useCallback(() => {
        const pIds = ['p1', 'p2', 'p3', 'p4'];
        const winners = pIds.filter(id => currentCards[id] === 0);
        
        if (winners.length !== 1) {
          // ä½¿ç”¨è‡ªè£½çš„ Modal å–ä»£ alertï¼Œä½†é€™è£¡ç°¡å–®èµ·è¦‹å…ˆä¿ç•™ä½ çš„é˜²å‘†è­¦å‘Š
          alert("å¿…é ˆå‰›å¥½æœ‰ä¸€äººè„«æ‰‹ï¼ˆå‰© 0 å¼µï¼‰æ‰èƒ½çµç®—å–”ï¼");
          return;
        }

        const winnerId = winners[0];
        let totalPot = 0;
        const roundScores = {};

        pIds.forEach(id => {
          if (id === winnerId) {
            roundScores[id] = 0;
          } else {
            let p = currentCards[id];
            if (p >= 8) p *= 2; // æ»¿8å¼µä»¥ä¸Šé›™å€
            if (twoCounts[id] > 0) p *= Math.pow(2, twoCounts[id]); // æ‰£è€äºŒç¿»å€
            if (winnerTwoCount > 0) p *= Math.pow(2, winnerTwoCount); // è´å®¶è€äºŒå°¾å…¨å ´ç¿»å€
            roundScores[id] = -p;
            totalPot += p;
          }
        });

        roundScores[winnerId] = totalPot;
        
        // æ›´æ–°ç©å®¶ç¸½åˆ†
        setPlayers(prev => prev.map(p => ({ ...p, score: p.score + roundScores[p.id] })));
        
        // å¯«å…¥æ­·å²ç´€éŒ„
        setHistory([{
          id: Date.now(),
          time: new Date().toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' }),
          scores: roundScores,
          isExtreme: winnerTwoCount > 0
        }, ...history]);

        // ç‹€æ…‹é‡ç½®ä¸¦åˆ‡æ›ç•«é¢
        setCurrentCards({ p1: 0, p2: 0, p3: 0, p4: 0 });
        setTwoCounts({ p1: 0, p2: 0, p3: 0, p4: 0 });
        setWinnerTwoCount(0);
        setActiveTab('scores');
      }, [currentCards, twoCounts, winnerTwoCount, history]);

      // æ“ä½œï¼šæ´—ç‰Œé‡å•Ÿ
      const handleReset = useCallback(() => {
        if(window.confirm("ç¢ºå®šè¦æŠŠæ‰€æœ‰äººçš„åˆ†æ•¸æ­¸é›¶ï¼Œé‡æ–°é–‹å§‹å—ï¼Ÿ\né€™å°‡æœƒæ¸…é™¤æ‰€æœ‰æˆ°å ±ç´€éŒ„ã€‚")) {
          setPlayers(INITIAL_PLAYERS);
          setHistory([]);
        }
      }, [INITIAL_PLAYERS]);

      /* =====================================================================
         ç•«é¢æ¸²æŸ“å€å¡Š
      ===================================================================== */
      return (
        <>
          {/* åº•å±¤ Canvas è² è²¬æ‰€æœ‰è¦–è¦ºç‰¹æ•ˆ */}
          <CanvasManager />

          {/* ä¸Šå±¤ UI å®¹å™¨ï¼šçµ•å°å®šä½ã€ä¸æ²å‹•ã€è™•ç†å®‰å…¨å€ */}
          <div className="absolute inset-0 z-10 flex flex-col mx-auto max-w-md pointer-events-none">
            
            {/* Header: ç©ºé–“å£“ç¸®ä½†ç¶­æŒå„ªé›… */}
            <header className="pt-[calc(var(--safe-top)+16px)] pb-4 px-6 flex justify-between items-start shrink-0 pointer-events-auto">
              <div className="flex flex-col gap-0.5">
                <span className="text-[13px] font-bold tracking-[0.2em] text-white/70 uppercase">Year of the Horse</span>
                <h1 className="text-[32px] font-black tracking-tight text-shine-gold drop-shadow-xl">
                  å¤§è€äºŒè¨˜åˆ†æ‰€
                </h1>
              </div>
              <button 
                onClick={() => setShowRules(true)} 
                className="w-10 h-10 rounded-full bg-white/10 border border-white/20 flex items-center justify-center ios-active-scale backdrop-blur-md mt-1"
                aria-label="æŸ¥çœ‹æ±Ÿæ¹–è¦çŸ©"
              >
                <Icon name="info" className="w-6 h-6 text-white/90" />
              </button>
            </header>

            {/* Main Content: ä¾ç…§ activeTab é¡¯ç¤ºä¸åŒå…§å®¹ */}
            <main className="flex-1 relative flex flex-col px-5 pb-[calc(90px+var(--safe-bottom))] min-h-0 pointer-events-auto">
              
              {/* --- ç•«é¢ Aï¼šè¨˜åˆ†æ“ä½œ (Play) --- */}
              {activeTab === 'play' && (
                <div className="flex-1 flex flex-col justify-between animate-in fade-in zoom-in-95 duration-300">
                  {/* ç©å®¶å¡ç‰‡åˆ—è¡¨ */}
                  <div className="flex flex-col gap-4 flex-1 min-h-0 py-2">
                    {INITIAL_PLAYERS.map(base => (
                      <PlayerControlCard 
                        key={base.id}
                        player={players.find(x => x.id === base.id)}
                        currentCards={currentCards[base.id]}
                        twoCount={twoCounts[base.id]}
                        onChangeCard={(delta) => changeCard(base.id, delta)}
                        onToggleTwo={() => toggleTwo(base.id)}
                      />
                    ))}
                  </div>

                  {/* åº•éƒ¨è¡Œå‹•å€ï¼šçµç®—æŒ‰éˆ•èˆ‡å…¨å ´åŠ æˆ */}
                  <div className="shrink-0 pt-4 space-y-3 relative z-10">
                    <button 
                      onClick={() => setWinnerTwoCount(v => (v + 1) % 5)}
                      className={`
                        w-full py-3.5 rounded-[20px] text-[15px] font-bold transition-all duration-300 ios-active-scale flex items-center justify-center gap-2
                        ${winnerTwoCount > 0 
                          ? 'bg-gradient-to-r from-red-600 to-rose-700 text-white shadow-[0_0_20px_rgba(220,38,38,0.4)] border border-red-400/50' 
                          : 'ios-glass-card text-white/80'
                        }
                      `}
                    >
                      {winnerTwoCount > 0 ? (
                        <><span>ğŸ”¥ å¤§æ‹›ï¼šè´å®¶è€äºŒçµå°¾ Ã— {winnerTwoCount}</span><span className="text-[11px] bg-black/30 px-2 py-0.5 rounded-md">å…¨å ´ç¿»å€</span></>
                      ) : (
                        <span>è´å®¶ä»¥ä¸€èˆ¬ç‰Œå‹è„«æ‰‹</span>
                      )}
                    </button>
                    
                    <button 
                      onClick={calculate}
                      className="w-full h-[64px] rounded-[24px] bg-gradient-to-r from-amber-400 via-yellow-500 to-amber-600 text-[#2a0000] text-[22px] font-black tracking-[0.1em] ios-active-scale shadow-[0_12px_30px_rgba(245,158,11,0.3)] border-b-2 border-amber-700"
                    >
                      å°ç›¤æ”¶éŒ¢
                    </button>
                  </div>
                </div>
              )}

              {/* --- ç•«é¢ Bï¼šæˆ°ç¸¾çµç®— (Scores) --- */}
              {activeTab === 'scores' && (
                <div className="flex-1 flex flex-col justify-center animate-in slide-in-from-bottom-8 duration-400">
                  <div className="ios-glass-card overflow-hidden flex flex-col w-full">
                    <div className="px-6 py-4 bg-black/20 border-b border-white/10 flex justify-between items-center">
                      <h2 className="text-[18px] font-bold text-amber-400 tracking-widest">ç›®å‰æ’å</h2>
                      <span className="text-[12px] text-white/40">ç¸½çµç®—çµæœ</span>
                    </div>
                    <div className="flex flex-col">
                      {[...players].sort((a, b) => b.score - a.score).map((p, idx) => {
                        const isFirst = idx === 0 && p.score > 0;
                        const scoreColor = p.score > 0 ? 'text-emerald-400' : p.score < 0 ? 'text-rose-400' : 'text-white/40';
                        return (
                          <div key={p.id} className={`relative px-6 py-5 flex items-center justify-between border-b border-white/5 last:border-0 ${isFirst ? 'bg-amber-500/10' : ''}`}>
                            {isFirst && <div className="absolute left-0 top-0 bottom-0 w-1.5 bg-gradient-to-b from-amber-300 to-yellow-500 rounded-r-md"></div>}
                            <div className="flex items-center gap-4">
                              <div className="w-8 flex justify-center">
                                {isFirst ? <Icon name="crown" className="w-8 h-8 text-amber-400 drop-shadow-[0_0_8px_rgba(251,191,36,0.6)]" /> : <span className="text-[20px] font-bold text-white/30">{idx + 1}</span>}
                              </div>
                              <span className="text-[22px] font-semibold tracking-wide text-white">{p.name}</span>
                            </div>
                            <span className={`text-[32px] font-black tabular-nums tracking-tight ${scoreColor}`}>
                              {p.score > 0 ? `+${p.score}` : p.score}
                            </span>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                  
                  <div className="mt-8 px-2">
                    <button 
                      onClick={handleReset} 
                      className="w-full h-[56px] rounded-[20px] text-[16px] font-bold tracking-widest text-amber-500 bg-black/40 border border-amber-900/50 backdrop-blur-md ios-active-scale"
                    >
                      é‡æ–°æ´—ç‰Œï¼Œé–‹æ–°å±€
                    </button>
                  </div>
                </div>
              )}

              {/* --- ç•«é¢ Cï¼šæ­·å²æ˜ç´° (History) --- */}
              {activeTab === 'history' && (
                <div className="flex-1 no-scrollbar pt-2 space-y-4 pb-10 animate-in slide-in-from-bottom-8 duration-400">
                  {history.length === 0 ? (
                    <div className="h-full flex flex-col items-center justify-center text-white/40 opacity-70">
                      <Icon name="history" className="w-16 h-16 mb-4 stroke-1" />
                      <p className="text-[18px] tracking-widest">ç›®å‰å°šç„¡æˆ°å ±ç´€éŒ„</p>
                    </div>
                  ) : (
                    history.map((rec) => (
                      <div key={rec.id} className="ios-glass-card p-5 transition-transform hover:scale-[1.02]">
                        <div className="flex justify-between items-center mb-4 pb-3 border-b border-white/10">
                          <div className="flex items-center gap-2">
                            <div className="w-2 h-2 rounded-full bg-amber-500 animate-pulse"></div>
                            <span className="text-[15px] font-medium text-white/80">{rec.time}</span>
                          </div>
                          {rec.isExtreme && (
                            <span className="text-[12px] font-bold bg-gradient-to-r from-red-600 to-rose-600 text-white px-3 py-1 rounded-[10px] shadow-sm">
                              å¤§æ‹›è§¸ç™¼
                            </span>
                          )}
                        </div>
                        <div className="grid grid-cols-4 gap-3 text-center">
                          {INITIAL_PLAYERS.map(p => {
                            const s = rec.scores[p.id];
                            return (
                              <div key={p.id} className="bg-black/20 py-2 rounded-[12px]">
                                <div className="text-[13px] text-white/50 mb-1">{p.name}</div>
                                <div className={`text-[18px] font-black tabular-nums ${s > 0 ? 'text-emerald-400' : s < 0 ? 'text-rose-400' : 'text-white/30'}`}>
                                  {s > 0 ? `+${s}` : s}
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    ))
                  )}
                </div>
              )}
            </main>

            {/* Bottom Navigation: å®Œç¾è²¼åˆå®‰å…¨å€ */}
            <nav className="absolute bottom-0 w-full ios-glass-nav pb-[var(--safe-bottom)] pt-3 z-20 shrink-0 pointer-events-auto">
              <div className="flex justify-around items-center max-w-sm mx-auto px-6">
                <button onClick={() => setActiveTab('scores')} className="relative flex flex-col items-center gap-1.5 w-20 py-2 ios-active-scale group">
                  <Icon name="trophy" className={`w-7 h-7 transition-colors duration-300 ${activeTab === 'scores' ? 'text-amber-400' : 'text-white/40 group-hover:text-white/60'}`} />
                  <span className={`text-[12px] font-bold tracking-wider transition-colors duration-300 ${activeTab === 'scores' ? 'text-amber-400' : 'text-white/40'}`}>æˆ°å ±</span>
                  {activeTab === 'scores' && <div className="absolute -top-3 w-10 h-1.5 bg-amber-400 rounded-full shadow-[0_0_12px_rgba(251,191,36,0.8)]"></div>}
                </button>
                <button onClick={() => setActiveTab('play')} className="relative flex flex-col items-center gap-1.5 w-20 py-2 ios-active-scale group">
                  <Icon name="play" className={`w-7 h-7 transition-colors duration-300 ${activeTab === 'play' ? 'text-amber-400' : 'text-white/40 group-hover:text-white/60'}`} />
                  <span className={`text-[12px] font-bold tracking-wider transition-colors duration-300 ${activeTab === 'play' ? 'text-amber-400' : 'text-white/40'}`}>è¨˜åˆ†</span>
                  {activeTab === 'play' && <div className="absolute -top-3 w-10 h-1.5 bg-amber-400 rounded-full shadow-[0_0_12px_rgba(251,191,36,0.8)]"></div>}
                </button>
                <button onClick={() => setActiveTab('history')} className="relative flex flex-col items-center gap-1.5 w-20 py-2 ios-active-scale group">
                  <Icon name="history" className={`w-7 h-7 transition-colors duration-300 ${activeTab === 'history' ? 'text-amber-400' : 'text-white/40 group-hover:text-white/60'}`} />
                  <span className={`text-[12px] font-bold tracking-wider transition-colors duration-300 ${activeTab === 'history' ? 'text-amber-400' : 'text-white/40'}`}>æ˜ç´°</span>
                  {activeTab === 'history' && <div className="absolute -top-3 w-10 h-1.5 bg-amber-400 rounded-full shadow-[0_0_12px_rgba(251,191,36,0.8)]"></div>}
                </button>
              </div>
            </nav>
          </div>

          {/* Bottom Sheet: éŠæˆ²è¦å‰‡ (å–ä»£é™½æ˜¥çš„ Modal) */}
          {showRules && (
            <div className="absolute inset-0 z-[100] flex flex-col justify-end pointer-events-auto">
              {/* é®ç½©é»æ“Šé—œé–‰ */}
              <div 
                className="absolute inset-0 bg-black/60 backdrop-blur-sm animate-in fade-in duration-300" 
                onClick={() => setShowRules(false)}
              ></div>
              
              {/* å…§å®¹å€å¡Šå¾åº•éƒ¨æ»‘å‡º */}
              <div className="relative w-full bg-[#1e0505] rounded-t-[36px] p-8 pb-[calc(32px+var(--safe-bottom))] shadow-[0_-20px_50px_rgba(0,0,0,0.5)] border-t border-red-900/30 animate-in slide-in-from-bottom-full duration-400">
                {/* é ‚éƒ¨æ‹–æ›³æŠŠæ‰‹è¦–è¦º */}
                <div className="w-12 h-1.5 bg-white/20 rounded-full mx-auto mb-8"></div>
                
                <div className="flex justify-between items-center mb-6">
                  <h3 className="text-[28px] font-black text-amber-400 tracking-widest">æ±Ÿæ¹–è¦çŸ©</h3>
                  <button onClick={() => setShowRules(false)} className="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center ios-active-scale">
                    <Icon name="close" className="w-5 h-5 text-white/70" />
                  </button>
                </div>

                <div className="space-y-6 text-[17px] leading-relaxed text-white/80">
                  <div className="flex gap-4 items-start">
                    <div className="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center shrink-0 text-white font-bold">1</div>
                    <p><strong className="text-white block mb-1">åŸºæœ¬ç›¤é¢</strong>å‰©ä¸‹ 1 åˆ° 7 å¼µç‰Œï¼ŒæŒ‰å¼µæ•¸ 1:1 æ‰£é™¤ã€‚å¦‚æœæ‰‹ä¸­å‰©ä¸‹ <span className="text-amber-400 font-bold">8 å¼µä»¥ä¸Š</span>ï¼Œç›´æ¥ç¿»å€æ‰£é™¤ã€‚</p>
                  </div>
                  
                  <div className="flex gap-4 items-start">
                    <div className="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center shrink-0 text-white font-bold">2</div>
                    <p><strong className="text-white block mb-1">æ‰‹æ¡è€äºŒ</strong>è¼¸å®¶è‹¥æ‰‹ä¸­æ‰£ç•™è€äºŒï¼Œæ¯ 1 å¼µç¿» 1 å€ï¼ˆ2å¼µè®Š4å€ï¼Œ3å¼µè®Š8å€ï¼Œä»¥æ­¤é¡æ¨ï¼‰ï¼Œé¢¨éšªæ¥µé«˜ã€‚</p>
                  </div>

                  <div className="flex gap-4 items-start bg-red-950/40 p-5 rounded-[20px] border border-red-900/50 mt-2">
                    <div className="w-8 h-8 rounded-full bg-red-500/20 flex items-center justify-center shrink-0 text-red-400 font-bold">ğŸ”¥</div>
                    <div>
                      <strong className="text-red-400 block mb-1">å¤§æ‹›ï¼šè€äºŒçµå°¾</strong>
                      <p className="text-[15px]">è´å®¶æœ€å¾Œä¸€å›åˆæ‰“å‡ºè€äºŒè„«æ‰‹ï¼Œå…¨å ´è¼¸å®¶å¼·åˆ¶ <span className="text-red-400 font-bold">å…¨é¡ç¿»å€</span>ã€‚å¯ç–ŠåŠ å¤šå¼µè€äºŒçµå°¾ç®—å€æ•¸ã€‚</p>
                    </div>
                  </div>
                </div>

                <button 
                  onClick={() => setShowRules(false)} 
                  className="w-full mt-8 h-[60px] bg-white/10 hover:bg-white/20 border border-white/20 rounded-[20px] text-[18px] font-bold text-white ios-active-scale transition-colors"
                >
                  ç­è§£ï¼Œé€€ä¸‹å§
                </button>
              </div>
            </div>
          )}
        </>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
